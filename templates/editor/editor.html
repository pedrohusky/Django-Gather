{% extends 'base.html' %}

{% block title %}Edit {{ realm.name }} - Gather Clone{% endblock %}

{% block extra_head %}
<script src="https://pixijs.download/release/pixi.min.js"></script>
{% endblock %}

{% block content %}
<div class="fixed inset-0 bg-gray-900 flex">
    <!-- Left Sidebar - Tools -->
    <div class="w-64 bg-white shadow-lg p-4 overflow-y-auto">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Map Editor</h2>
        
        <!-- Realm Info -->
        <div class="mb-6 p-3 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Editing</p>
            <p class="text-lg font-semibold text-gray-900">{{ realm.name }}</p>
        </div>

        <!-- Tools -->
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Tools</h3>
            <div class="space-y-2">
                <button id="tool-draw" class="w-full text-left px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    ‚úèÔ∏è Draw
                </button>
                <button id="tool-erase" class="w-full text-left px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    üóëÔ∏è Erase
                </button>
                <button id="tool-block" class="w-full text-left px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    üö´ Block Tile
                </button>
                <button id="tool-spawn" class="w-full text-left px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    üéØ Set Spawn
                </button>
                <button id="tool-teleport" class="w-full text-left px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    üö™ Teleporter
                </button>
                <button id="tool-private" class="w-full text-left px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    üîí Private Area
                </button>
            </div>
        </div>

        <!-- Tile Palette -->
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Tiles</h3>
            <div class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                <button class="tile-option p-2 border-2 border-gray-300 rounded hover:border-blue-500" data-tile="ground_0">
                    <div class="w-full h-12 bg-green-200 rounded"></div>
                    <p class="text-xs text-center mt-1">Ground</p>
                </button>
                <button class="tile-option p-2 border-2 border-gray-300 rounded hover:border-blue-500" data-tile="floor_0">
                    <div class="w-full h-12 bg-gray-400 rounded"></div>
                    <p class="text-xs text-center mt-1">Floor</p>
                </button>
                <button class="tile-option p-2 border-2 border-gray-300 rounded hover:border-blue-500" data-tile="water_0">
                    <div class="w-full h-12 bg-blue-300 rounded"></div>
                    <p class="text-xs text-center mt-1">Water</p>
                </button>
            </div>
        </div>

        <!-- Actions -->
        <div class="space-y-2">
            <button id="save-map" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-semibold">
                üíæ Save Map
            </button>
            <a href="{% url 'dashboard' %}" class="block text-center w-full bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 font-semibold">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="flex-1 relative">
        <div id="editor-container" class="w-full h-full"></div>
        
        <!-- Canvas Controls -->
        <div class="absolute top-4 right-4 bg-white/90 rounded-lg p-4 shadow-lg">
            <p class="text-sm text-gray-600 mb-2">Canvas Controls</p>
            <div class="space-y-2 text-sm">
                <p>üñ±Ô∏è Click to place tile</p>
                <p>‚å®Ô∏è Arrow keys to pan</p>
                <p>üîç Scroll to zoom</p>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="absolute bottom-4 left-4 bg-white/90 rounded-lg p-3 shadow-lg">
            <p class="text-sm"><span class="font-semibold">Position:</span> <span id="cursor-pos">0, 0</span></p>
            <p class="text-sm"><span class="font-semibold">Tool:</span> <span id="current-tool">Draw</span></p>
        </div>
    </div>
</div>

<script>
    const realmId = {{ realm.id }};
    const mapData = {{ realm.map_data|safe }};
    let currentTool = 'draw';
    let selectedTile = 'ground_0';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Tool selection
    document.querySelectorAll('[id^="tool-"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('[id^="tool-"]').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('bg-gray-200', 'text-gray-700');
            });
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            btn.classList.add('bg-blue-600', 'text-white');
            
            currentTool = btn.id.replace('tool-', '');
            document.getElementById('current-tool').textContent = btn.textContent.trim().split(' ')[1];
        });
    });

    // Tile selection
    document.querySelectorAll('.tile-option').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tile-option').forEach(b => {
                b.classList.remove('border-blue-600');
                b.classList.add('border-gray-300');
            });
            btn.classList.remove('border-gray-300');
            btn.classList.add('border-blue-600');
            selectedTile = btn.dataset.tile;
        });
    });

    // Save map
    document.getElementById('save-map').addEventListener('click', async () => {
        try {
            const response = await fetch(`/api/realms/${realmId}/save/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    map_data: mapData
                })
            });

            const data = await response.json();
            if (data.success) {
                alert('Map saved successfully!');
            } else {
                alert('Error saving map. Please try again.');
            }
        } catch (error) {
            alert('Error saving map. Please try again.');
        }
    });

    // Initialize basic Pixi.js canvas
    const app = new PIXI.Application({
        width: window.innerWidth - 256,
        height: window.innerHeight,
        backgroundColor: 0x1a1a1a,
        antialias: true
    });

    document.getElementById('editor-container').appendChild(app.view);

    // Basic grid rendering
    const graphics = new PIXI.Graphics();
    app.stage.addChild(graphics);

    function drawGrid() {
        graphics.clear();
        graphics.lineStyle(1, 0x333333, 0.5);
        
        const gridSize = 32;
        const cols = Math.ceil(app.view.width / gridSize);
        const rows = Math.ceil(app.view.height / gridSize);

        for (let i = 0; i <= cols; i++) {
            graphics.moveTo(i * gridSize, 0);
            graphics.lineTo(i * gridSize, app.view.height);
        }
        
        for (let i = 0; i <= rows; i++) {
            graphics.moveTo(0, i * gridSize);
            graphics.lineTo(app.view.width, i * gridSize);
        }
    }

    drawGrid();

    // Track mouse position
    app.view.addEventListener('mousemove', (e) => {
        const rect = app.view.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / 32);
        const y = Math.floor((e.clientY - rect.top) / 32);
        document.getElementById('cursor-pos').textContent = `${x}, ${y}`;
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        app.renderer.resize(window.innerWidth - 256, window.innerHeight);
        drawGrid();
    });
</script>
{% endblock %}
