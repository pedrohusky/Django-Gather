{% extends 'base.html' %}

{% block title %}Profile - Gather Clone{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-4xl font-bold text-gray-900 mb-8">Profile Settings</h1>

    <div class="bg-white rounded-lg shadow-lg p-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Account Information</h2>
            <div class="space-y-2">
                <p class="text-gray-700"><strong>Username:</strong> {{ user.username }}</p>
                <p class="text-gray-700"><strong>Email:</strong> {{ user.email }}</p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Character Skin</h2>
            <p class="text-gray-600 mb-4">Select your character appearance</p>
            
            <!-- Current Skin Preview -->
            <div class="mb-6 p-6 bg-gray-50 rounded-lg text-center">
                <p class="text-sm text-gray-600 mb-3">Current Skin</p>
                <div id="current-skin-preview" class="flex justify-center">
                    <img src="/static/sprites/characters/Character_{{ current_skin }}.png" 
                         alt="Current Skin" 
                         class="w-32 h-32 object-contain">
                </div>
                <p class="text-sm font-semibold text-gray-700 mt-2">Skin {{ current_skin }}</p>
            </div>

            <!-- Skin Selector Grid -->
            <div class="grid grid-cols-6 md:grid-cols-8 gap-3 max-h-96 overflow-y-auto p-4 border border-gray-200 rounded-lg">
                {% for skin in skins %}
                <button type="button" 
                        class="skin-option border-2 rounded-lg p-2 hover:border-blue-500 transition {% if skin == current_skin %}border-blue-600 bg-blue-50{% else %}border-gray-300{% endif %}"
                        data-skin="{{ skin }}"
                        onclick="selectSkin('{{ skin }}')">
                    <img src="/static/sprites/characters/Character_{{ skin }}.png" 
                         alt="Skin {{ skin }}" 
                         class="w-full h-full object-contain">
                    <p class="text-xs text-center mt-1">{{ skin }}</p>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="flex justify-end gap-4">
            <a href="{% url 'dashboard' %}" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300">
                Cancel
            </a>
            <button id="save-profile-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                Save Changes
            </button>
        </div>
    </div>
</div>

<script>
    let selectedSkin = "{{ current_skin }}";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function selectSkin(skin) {
        selectedSkin = skin;
        
        // Update all skin option borders
        document.querySelectorAll('.skin-option').forEach(btn => {
            if (btn.dataset.skin === skin) {
                btn.classList.remove('border-gray-300');
                btn.classList.add('border-blue-600', 'bg-blue-50');
            } else {
                btn.classList.remove('border-blue-600', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            }
        });

        // Update preview
        const preview = document.getElementById('current-skin-preview');
        preview.innerHTML = `<img src="/static/sprites/characters/Character_${skin}.png" 
                                  alt="Selected Skin" 
                                  class="w-32 h-32 object-contain">`;
        preview.nextElementSibling.textContent = `Skin ${skin}`;
    }

    document.getElementById('save-profile-btn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/profile/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ skin: selectedSkin })
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = "{% url 'dashboard' %}";
            } else {
                alert('Error saving profile. Please try again.');
            }
        } catch (error) {
            alert('Error saving profile. Please try again.');
        }
    });
</script>
{% endblock %}
